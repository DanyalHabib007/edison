{% extends "base.html" %}

{% block content %}
<div class="box has-background-info-light">
    <div class="level is-mobile mb-2">
    <div class="level-left">
        <h2 class="subtitle is-5 has-text-grey">Dashboard</h2>
    </div>
    <div class="level-right">
        <a href="/download_db" class="button is-small is-dark is-outlined mr-2" title="Download Database Backup">
            <span class="icon">
                <i class="fas fa-download"></i>
            </span>
            <span>Backup</span>
        </a>

        <form action="/restore_db" method="post" enctype="multipart/form-data">
            <label class="button is-small is-warning is-outlined" title="Restore Database">
                <span class="icon">
                    <i class="fas fa-upload"></i>
                </span>
                <span>Restore</span>
                <input 
                    type="file" 
                    name="file" 
                    accept=".db" 
                    style="display: none;" 
                    onchange="if(confirm('⚠️ WARNING: This will overwrite all current data with the backup file. Are you sure?')) { this.form.submit(); }"
                >
            </label>
        </form>
    </div>
</div>

<div class="box has-background-info-light">
    <div class="level is-mobile">
        <div class="level-item has-text-centered">
            <div>
                <p class="heading">You will get</p>
                <p class="title is-4 is-red">₹ {{ total_to_collect }}</p>
            </div>
        </div>
    </div>
</div>

<div class="box">
    <h3 class="title is-5">Add New Customer</h3>
    <form action="/add_customer" method="post" class="field has-addons">
        <div class="control is-expanded">
            <input class="input" type="text" name="name" placeholder="Customer Name" required>
        </div>
        <div class="control is-expanded">
            <input class="input" type="tel" name="phone" placeholder="Phone Number" required>
        </div>
        <div class="control">
            <button class="button is-primary" type="submit">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </form>
</div>

<div class="box" style="padding: 10px;">
    <form action="/" method="get">
        <div class="field has-addons">
            <div class="control has-icons-left is-expanded">
                <input class="input" type="text" name="q" placeholder="Search by Name or Phone..." value="{{ q or '' }}">
                <span class="icon is-small is-left">
                    <i class="fas fa-search"></i>
                </span>
            </div>
            <div class="control">
                <button class="button is-info" type="submit">
                    Search
                </button>
            </div>
            {% if q %}
            <div class="control">
                <a href="/" class="button is-light">
                    Clear
                </a>
            </div>
            {% endif %}
        </div>
    </form>
</div>
<div class="box" style="padding: 10px; margin-top: 10px; background-color: #fcfcfc;">
    <form action="/" method="get" id="filterForm">
        {% if q %}
        <input type="hidden" name="q" value="{{ q }}">
        {% endif %}

        <div class="level is-mobile">
            <div class="level-left">
                <span class="icon has-text-grey mr-2"><i class="fas fa-sort"></i></span>
                <span class="has-text-weight-medium is-size-7-mobile">Sort by:</span>
            </div>
            <div class="level-right" style="flex-grow: 1; max-width: 70%;">
                <div class="control is-expanded">
                    <div class="select is-fullwidth is-small">
                        <select name="sort" onchange="document.getElementById('filterForm').submit()">
                            <option value="date_desc" {% if sort == 'date_desc' %}selected{% endif %}>Recent Transaction</option>
                            <option value="date_asc" {% if sort == 'date_asc' %}selected{% endif %}>Oldest Transaction</option>
                            <option value="bal_high" {% if sort == 'bal_high' %}selected{% endif %}>Amount: High to Low</option>
                            <option value="bal_low" {% if sort == 'bal_low' %}selected{% endif %}>Amount: Low to High</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="box">
    <h3 class="title is-5">Your Customers</h3>
    
    {% if not customers %}
        <div class="has-text-centered py-4">
            {% if q %}
                <p class="has-text-grey">No results found for "{{ q }}"</p>
                <a href="/">Show all customers</a>
            {% else %}
                <p class="has-text-grey">No customers added yet.</p>
            {% endif %}
        </div>
    {% endif %}
    
    {% for customer in customers %}
    <a href="/customer/{{ customer.id }}" style="text-decoration: none; color: inherit;">
        <div class="media" style="border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; padding-top: 10px;">
            <div class="media-left">
                <figure class="image is-48x48">
                    <div class="is-flex is-align-items-center is-justify-content-center has-background-primary has-text-white is-rounded" style="width: 100%; height: 100%; border-radius: 50%; font-weight: bold; font-size: 1.2rem;">
                        {{ customer.name[0].upper() }}
                    </div>
                </figure>
            </div>
            <div class="media-content">
    <p class="title is-6" style="margin-bottom: 0;">{{ customer.name }}</p>
    
    <p class="subtitle is-7" style="margin-top: 2px; margin-bottom: 2px;">{{ customer.phone }}</p>
    
    {% if customer.last_activity != "1970-01-01 00:00:00" %}
        <p class="is-size-7 has-text-grey-light">
            <i class="far fa-clock"></i> {{ customer.last_activity[:10] }}
        </p>
    {% endif %}
</div>
            <div class="media-right has-text-right">
                {% if customer.balance > 0 %}
                    <p class="title is-6 is-red">{{ customer.balance }}</p>
                    <p class="subtitle is-7">You will get</p>
                {% elif customer.balance < 0 %}
                    <p class="title is-6 is-green">{{ customer.balance | abs }}</p>
                    <p class="subtitle is-7">You will give</p>
                {% else %}
                    <p class="title is-6 has-text-grey">0</p>
                    <p class="subtitle is-7">Settled</p>
                {% endif %}
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% endblock %}
